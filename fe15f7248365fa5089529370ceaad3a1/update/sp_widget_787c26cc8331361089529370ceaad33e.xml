<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $window, $timeout) {
    var c = this;
    console.log('=== Retro Details Widget Loaded ===');
    console.log('Retrospective:', $scope.data.retro);
    console.log('Tasks Count:', $scope.data.tasks.length);
    console.log('Is Owner:', $scope.data.isOwner);
    
    // Initialize state
    c.editing = false;
    c.saving = false;
    c.editForm = {};
    
    // Go back to previous page
    c.goBack = function() {
        $window.history.back();
    };
    
    // Start editing retrospective
    c.startEditing = function() {
        console.log('Starting edit mode');
        c.editing = true;
        c.editForm = {
            start: $scope.data.retro.start,
            stop: $scope.data.retro.stop,
            continue_doing: $scope.data.retro.continue_doing
        };
    };
    
    // Cancel editing
    c.cancelEditing = function() {
        console.log('Canceling edit mode');
        c.editing = false;
        c.editForm = {};
        $scope.data.error = null;
    };
    
    // Save retrospective changes (using $scope.data)
    c.saveRetro = function() {
        // Validate
        if (!c.editForm.start || !c.editForm.stop || !c.editForm.continue_doing) {
            $scope.data.error = 'All fields are required.';
            return;
        }
        c.saving = true;
        // Put data onto $scope.data, which becomes `input` on the server
        $scope.data.action         = 'saveRetro';
        $scope.data.retroId        = $scope.data.retro.sysId;
        $scope.data.start          = c.editForm.start;
        $scope.data.stop           = c.editForm.stop;
        $scope.data.continue_doing = c.editForm.continue_doing;
        console.log('Saving retrospective via $scope.data:', $scope.data);
        c.server.update($scope.data).then(function(response) {
            c.saving = false;
            var r = response.data || response;
            var result = r.result || r;
            var respData = result.data || result;
            console.log('Server response (unwrapped):', respData);
            if (respData.success) {
                console.log('✓ Saved successfully');
                $scope.data.success = respData.success;
                $scope.data.error = null;
                // Update local retro values
                $scope.data.retro.start = c.editForm.start;
                $scope.data.retro.stop = c.editForm.stop;
                $scope.data.retro.continue_doing = c.editForm.continue_doing;
                c.editing = false;
                c.editForm = {};
                $timeout(function() {
                    $scope.data.success = null;
                }, 3000);
            } else if (respData.error) {
                console.error('✗ Error:', respData.error);
                $scope.data.error = respData.error;
                $scope.data.success = null;
            } else {
                console.warn('No success or error in save response', respData);
                $scope.data.error = 'An unexpected error occurred.';
                $scope.data.success = null;
            }
        }).catch(function(error) {
            c.saving = false;
            console.error('✗ Server error:', error);
            $scope.data.error = 'Failed to save. Please try again.';
        });
    };
    
    // View task details
    c.viewTask = function(taskId, $event) {
        if ($event) {
            $event.preventDefault();
            $event.stopPropagation();
        }
        console.log('Opening task details for:', taskId);
        $window.location.href = '/sp?id=task_details&task_id=' + taskId;
    };
}]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>retro_details</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Retro Details</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
    gs.info('=== Retro Details Widget ===');
    
    data.retro = null;
    data.tasks = [];
    data.error = null;
    data.currentUser = gs.getUserID();
    data.isOwner = false;
    
    // Get retro sys_id from URL parameter
    var retroId = $sp.getParameter('retro_id');
    gs.info('Loading retro with ID: ' + retroId);
    
    if (!retroId) {
        data.error = 'No retrospective ID provided.';
        gs.warn('No retro_id parameter');
        return;
    }
    
    // Load retrospective
    var retroGR = new GlideRecord('x_1865669_retrospe_retrospective_submission');
    if (retroGR.get(retroId)) {
        var sprintGR = new GlideRecord('x_1865669_retrospe_sprint');
        sprintGR.get(retroGR.getValue('sprint'));
        
        var retroStatus = retroGR.getValue('status');
        var isOwner = (retroGR.getValue('submitted_by') === data.currentUser);
        var isEditable = (retroStatus === 'submitted' && isOwner);
        
        gs.info('Retro Status: ' + retroStatus);
        gs.info('Is Owner: ' + isOwner);
        gs.info('Is Editable: ' + isEditable);
        
        data.retro = {
            sysId: retroGR.getUniqueValue(),
            sprintName: sprintGR.getValue('sprint_name') || 'Unknown Sprint',
            sprintId: retroGR.getValue('sprint'),
            start: retroGR.getValue('start_items'),
            stop: retroGR.getValue('stop_items'),
            continue_doing: retroGR.getValue('continue_items'),
            submittedBy: retroGR.getDisplayValue('submitted_by'),
            submittedDate: retroGR.getDisplayValue('submitted_date'),
            status: retroStatus,
            isEditable: isEditable
        };
        
        // Check if current user is the owner
        if (isOwner) {
            data.isOwner = true;
        }
        
        gs.info('Loaded retro: ' + data.retro.sprintName);
    } else {
        data.error = 'Retrospective not found.';
        gs.warn('Retro not found with ID: ' + retroId);
        return;
    }
    
    // Load related tasks
    gs.info('Loading tasks for retro: ' + retroId);
    var taskGR = new GlideRecord('x_1865669_retrospe_retrospective_task');
    taskGR.addQuery('retro_submission', retroId);
    taskGR.orderByDesc('created_on');
    taskGR.query();
    
    while (taskGR.next()) {
        data.tasks.push({
            sysId: taskGR.getUniqueValue(),
            title: taskGR.getValue('title'),
            description: taskGR.getValue('description'),
            status: taskGR.getDisplayValue('status'),
            priority: taskGR.getDisplayValue('priority'),
            dueDate: taskGR.getDisplayValue('due_date'),
            assignedTo: taskGR.getDisplayValue('assigned_to'),
            createdOn: taskGR.getDisplayValue('created_on')
        });
    }
    
    gs.info('Found ' + data.tasks.length + ' tasks');
    
    // Handle save retrospective action
    if (input && input.action === 'saveRetro') {
        gs.info('Saving retrospective: ' + input.retroId);
        
        try {
            var saveRetroGR = new GlideRecord('x_1865669_retrospe_retrospective_submission');
            if (saveRetroGR.get(input.retroId)) {
                // Check if user is owner
                if (saveRetroGR.getValue('submitted_by') !== data.currentUser) {
                    data.error = 'You do not have permission to edit this retrospective.';
                    gs.warn('Unauthorized edit attempt by: ' + data.currentUser);
                    return;
                }
                
                // Check if status is 
							
                if (saveRetroGR.getValue('status') !== 'submitted') {
                    data.error = 'This retrospective is no longer editable.';
                    gs.warn('Edit attempt on non-submit status: ' + saveRetroGR.getValue('status'));
                    return;
                }
                
                // Validate input
                if (!input.start || !input.stop || !input.continue_doing) {
                    data.error = 'All fields are required.';
                    return;
                }
                
                // Update fields
                saveRetroGR.setValue('start_items', input.start);
                saveRetroGR.setValue('stop_items', input.stop);
                saveRetroGR.setValue('continue_items', input.continue_doing);
                saveRetroGR.update();
                
                data.success = 'Retrospective updated successfully.';
                gs.info('✓ Retrospective updated: ' + input.retroId);
                
                // Update local data
                data.retro.start = input.start;
                data.retro.stop = input.stop;
                data.retro.continue_doing = input.continue_doing;
            } else {
                data.error = 'Retrospective not found.';
            }
        } catch (e) {
            data.error = 'Error updating retrospective: ' + e.message;
            gs.error('Exception: ' + e.message);
        }
    }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-09 05:24:28</sys_created_on>
        <sys_id>787c26cc8331361089529370ceaad33e</sys_id>
        <sys_mod_count>25</sys_mod_count>
        <sys_name>Retro Details</sys_name>
        <sys_package display_value="Retrospective Management" source="x_1865669_retrospe">fe15f7248365fa5089529370ceaad3a1</sys_package>
        <sys_policy/>
        <sys_scope display_value="Retrospective Management">fe15f7248365fa5089529370ceaad3a1</sys_scope>
        <sys_update_name>sp_widget_787c26cc8331361089529370ceaad33e</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-12-10 14:52:06</sys_updated_on>
        <template><![CDATA[<div class="panel panel-default retro-details">

  <!-- Error/Success Messages -->
  <div ng-if="data.error" class="alert alert-danger m-b-md">
    <i class="fa fa-exclamation-circle"></i> {{data.error}}
    <button type="button" class="close" ng-click="data.error = null">×</button>
  </div>

  <div ng-if="data.success" class="alert alert-success m-b-md">
    <i class="fa fa-check-circle"></i> {{data.success}}
  </div>

  <!-- No Retro Found -->
  <div ng-if="!data.retro" class="alert alert-warning">
    <i class="fa fa-exclamation-triangle"></i>
    {{data.error || 'Retrospective not found.'}}
  </div>

  <!-- Retro Details -->
  <div ng-if="data.retro">
    <!-- Header -->
    <div class="panel-heading clearfix">
      <div class="pull-left">
        <h3 class="panel-title m-t-none m-b-xs">
          <i class="fa fa-comments"></i>
          {{data.retro.sprintName}}
        </h3>
        <small class="text-muted">
          Submitted by:
          <strong>{{data.retro.submittedBy}}</strong>
          on {{data.retro.submittedDate}}
        </small>
      </div>

      <div class="pull-right">
        <button class="btn btn-default btn-sm" ng-click="c.goBack()">
          <i class="fa fa-arrow-left"></i> Back
        </button>

        <!-- Edit Button - only if owner and editable -->
        <button class="btn btn-primary btn-sm"
                ng-if="data.isOwner && data.retro.isEditable && !c.editing"
                ng-click="c.startEditing()">
          <i class="fa fa-pencil"></i> Edit
        </button>

        <!-- Info when not editable -->
        <small class="text-muted"
               ng-if="!data.isOwner">
          (You are not the owner)
        </small>
        <small class="text-muted"
               ng-if="data.isOwner && !data.retro.isEditable">
          (Status: {{data.retro.status}} – only "submit" status is editable)
        </small>

        <!-- Save / Cancel in edit mode -->
        <button class="btn btn-success btn-sm"
                ng-if="c.editing"
                ng-click="c.saveRetro()"
                ng-disabled="c.saving">
          <i class="fa fa-save"></i>
          {{c.saving ? 'Saving...' : 'Save'}}
        </button>
        <button class="btn btn-default btn-sm"
                ng-if="c.editing"
                ng-click="c.cancelEditing()">
          <i class="fa fa-times"></i> Cancel
        </button>
      </div>
    </div>

    <!-- Body -->
    <div class="panel-body">
      <!-- View Mode -->
      <div ng-if="!c.editing">
        <div class="row">
          <div class="col-md-4">
            <div class="retro-section">
              <h4 class="m-t-none m-b-sm text-success border-bottom">
                <i class="fa fa-play"></i> START
              </h4>
              <p class="m-b-none">{{data.retro.start}}</p>
            </div>
          </div>

          <div class="col-md-4">
            <div class="retro-section">
              <h4 class="m-t-none m-b-sm text-danger border-bottom">
                <i class="fa fa-stop"></i> STOP
              </h4>
              <p class="m-b-none">{{data.retro.stop}}</p>
            </div>
          </div>

          <div class="col-md-4">
            <div class="retro-section">
              <h4 class="m-t-none m-b-sm text-primary border-bottom">
                <i class="fa fa-refresh"></i> CONTINUE
              </h4>
              <p class="m-b-none">{{data.retro.continue_doing}}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode -->
      <div ng-if="c.editing">
        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label class="text-success">
                <i class="fa fa-play"></i> START
              </label>
              <textarea class="form-control"
                        rows="6"
                        ng-model="c.editForm.start"
                        placeholder="What should we start doing?">
              </textarea>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-group">
              <label class="text-danger">
                <i class="fa fa-stop"></i> STOP
              </label>
              <textarea class="form-control"
                        rows="6"
                        ng-model="c.editForm.stop"
                        placeholder="What should we stop doing?">
              </textarea>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-group">
              <label class="text-primary">
                <i class="fa fa-refresh"></i> CONTINUE
              </label>
              <textarea class="form-control"
                        rows="6"
                        ng-model="c.editForm.continue_doing"
                        placeholder="What should we continue doing?">
              </textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tasks Section -->
  <div ng-if="data.retro" class="m-t-md">
    <div class="panel panel-info">
      <div class="panel-heading">
        <h4 class="panel-title m-t-none">
          <i class="fa fa-tasks"></i>
          Related Tasks
          <span class="badge">{{data.tasks.length}}</span>
        </h4>
      </div>

      <div class="panel-body">
        <!-- No Tasks -->
        <div ng-if="data.tasks.length === 0" class="alert alert-info m-b-none">
          <i class="fa fa-info-circle"></i>
          No tasks created from this retrospective yet.
        </div>

        <!-- Tasks Table -->
        <div ng-if="data.tasks.length > 0" class="table-responsive m-b-none">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Title</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Assigned To</th>
                <th>Due Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="task in data.tasks">
                <td>
                  <strong>{{task.title}}</strong><br>
                  <small class="text-muted">
                    {{task.description | limitTo:50}}
                    {{task.description.length > 50 ? '...' : ''}}
                  </small>
                </td>
                <td>
                  <span class="label"
                        ng-class="{
                          'label-success': task.status === 'Completed',
                          'label-warning': task.status === 'In Progress',
                          'label-default': task.status === 'Not Started'
                        }">
                    {{task.status}}
                  </span>
                </td>
                <td>
                  <span class="label"
                        ng-class="{
                          'label-danger': task.priority === 'High',
                          'label-warning': task.priority === 'Medium',
                          'label-info': task.priority === 'Low'
                        }">
                    {{task.priority}}
                  </span>
                </td>
                <td>{{task.assignedTo}}</td>
                <td>
                  <span ng-if="task.dueDate">{{task.dueDate}}</span>
                  <span ng-if="!task.dueDate" class="text-muted">-</span>
                </td>
                <td>
                  <button class="btn btn-xs btn-info"
                          ng-click="c.viewTask(task.sysId)"
                          title="View">
                    <i class="fa fa-eye"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
