<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $window, $timeout) {
  var c = this;

  console.log('=== Retro Task Details Widget Loaded ===');
  console.log('Task:', $scope.data.task);
  console.log('Can Edit:', $scope.data.canEdit);

  // ============== STATE ==============
  c.isEditMode = false;
  c.form = {};
  c.saving = false;

  // ============== INITIALIZATION ==============
  c.initialize = function() {
    if ($scope.data.task) {
      c.form = {
        state: $scope.data.task.state_value || '100',          // '100','200','300','400'
        short_description: $scope.data.task.short_description || '',
        description: $scope.data.task.description || '',
        priority: $scope.data.task.priority || '2',
        work_note: ''
      };
    }
  };

  c.initialize();

  // ============== NAVIGATION ==============
  c.goBack = function() {
    console.log('Going back');
    $window.history.back();
  };

  // ============== EDIT MODE ==============
  c.enterEditMode = function() {
    console.log('Entering edit mode');

    if (!$scope.data.task || !$scope.data.canEdit)
      return;

    c.isEditMode = true;
    c.form = {
      state: $scope.data.task.state_value || '100',
      short_description: $scope.data.task.short_description || '',
      description: $scope.data.task.description || '',
      priority: $scope.data.task.priority || '2',
      work_note: ''
    };
    $scope.data.error = null;
    $scope.data.success = null;
  };

  c.cancelEdit = function() {
    console.log('Canceling edit mode');
    c.isEditMode = false;
    c.form = {};
    $scope.data.error = null;
    $scope.data.success = null;
  };

  // ============== SAVE TASK ==============
  c.save = function() {
    if (!$scope.data.task || !$scope.data.task.sys_id)
      return;

    // Validate
    if (!c.form.short_description || !c.form.short_description.trim()) {
      $scope.data.error = 'Task title is required';
      return;
    }

    c.saving = true;
    $scope.data.error = null;
    $scope.data.success = null;

    console.log('Saving task with updates:', c.form);

    // Prepare payload for server (becomes `input`)
    $scope.data.action            = 'save';
    $scope.data.task_id           = $scope.data.task.sys_id;
    $scope.data.state             = c.form.state;
    $scope.data.short_description = c.form.short_description.trim();
    $scope.data.description       = c.form.description;
    $scope.data.priority          = c.form.priority;
    $scope.data.work_note         = c.form.work_note;

    c.server.update($scope.data).then(function(response) {
      c.saving = false;

      // Unwrap like other widgets
      var r = response.data || response;
      var result = r.result || r;
      var res = result.data || result;

      console.log('Server response:', res);

      if (!res) {
        $scope.data.error = 'No response from server';
        return;
      }

      if (res.error) {
        console.error('✗ Error:', res.error);
        $scope.data.error = res.error || 'Failed to save task';
        return;
      }

      // Success path
      console.log('✓ Task saved successfully');

      if (res.task)
        $scope.data.task = res.task;

      if (res.workNotes)
        $scope.data.workNotes = res.workNotes;

      $scope.data.success = res.success || 'Task updated successfully';

      // Exit edit mode and refresh form
      c.isEditMode = false;
      c.form = {
        state: $scope.data.task.state_value || '100',
        short_description: $scope.data.task.short_description || '',
        description: $scope.data.task.description || '',
        priority: $scope.data.task.priority || 'Medium',
        work_note: ''
      };

      // Auto-hide success message after 4 seconds
      $timeout(function() {
        $scope.data.success = null;
      }, 4000);

      // Optional: clear transient payload fields
      $scope.data.action = null;
      $scope.data.task_id = null;
      $scope.data.state = null;
      $scope.data.short_description = null;
      $scope.data.description = null;
      $scope.data.priority = null;
      $scope.data.work_note = null;

    }).catch(function(error) {
      c.saving = false;
      console.error('✗ Server error:', error);
      $scope.data.error = 'Failed to save task. Please try again.';
    });
  };

  // ============== WATCHERS ==============
  $scope.$watch('data.task', function(newVal) {
    if (newVal) {
      console.log('Task data changed:', newVal);
      c.initialize();
    }
  }, true);

  $scope.$watch('data.error', function(newVal) {
    if (newVal) {
      console.log('Error:', newVal);
    }
  });
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.modern-task-details {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.alert-message {
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  animation: slideIn 0.3s ease;
}

.alert-error {
  background: #fee;
  border-left: 4px solid #e53e3e;
  color: #c53030;
}

.alert-success {
  background: #f0fdf4;
  border-left: 4px solid #10b981;
  color: #047857;
}

.task-header {
  background: white;
  border: 1px solid #e2e8f0;
  padding: 24px;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.task-header-content {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: 16px;
}

.task-title {
  font-size: 24px;
  font-weight: 600;
  margin: 0 0 8px 0;
  color: #2d3748;
}

.task-meta {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  font-size: 14px;
  color: #718096;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-group {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-primary {
  background: #667eea;
  color: white;
}

.btn-success {
  background: #10b981;
  color: white;
}

.btn-default {
  background: white;
  color: #4a5568;
  border: 1px solid #e2e8f0;
}

.content-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-top: 24px;
}

@media (max-width: 768px) {
  .content-grid {
    grid-template-columns: 1fr;
  }
}

.card {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border: 1px solid #e2e8f0;
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  margin: 0 0 16px 0;
  display: flex;
  align-items: center;
  gap: 8px;
  color: #2d3748;
}

.info-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #f7fafc;
}

.info-row:last-child {
  border-bottom: none;
}

.info-label {
  font-weight: 500;
  color: #718096;
}

.info-value {
  color: #2d3748;
  font-weight: 500;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #4a5568;
  font-size: 14px;
}

/* Row for State + Priority */
.form-row {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
}

.form-group-half {
  flex: 1;
}

@media (max-width: 768px) {
  .form-row {
    flex-direction: column;
  }
}
.form-control {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.4;     /* add this */
  height: auto;         /* let browser size correctly */
  box-sizing: border-box;
}

.card {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border: 1px solid #e2e8f0;
  overflow: visible;    /* important to avoid clipping at bottom */
}

select.form-control {
  padding-top: 8px;
  padding-bottom: 8px;
  line-height: 1.4;
}

.form-control:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.work-note {
  background: #f8fafc;
  border-left: 3px solid #667eea;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 12px;
}

.work-note-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.work-note-author {
  font-weight: 600;
  color: #2d3748;
}

.work-note-date {
  color: #718096;
  font-size: 13px;
}

.work-note-text {
  color: #4a5568;
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.5;
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: #a0aec0;
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.badge-pending { background: #fef3c7; color: #92400e; }
.badge-progress { background: #dbeafe; color: #1e40af; }
.badge-completed { background: #d1fae5; color: #065f46; }
.badge-cancelled { background: #fee2e2; color: #991b1b; }

.priority-low { color: #10b981; }
.priority-medium { color: #f59e0b; }
.priority-high { color: #ef4444; }
.priority-critical { color: #dc2626; font-weight: 700; }

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>retro_task_details</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Retro task details</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  gs.info('=== Retro Task Details Widget ===');

  data.error = null;
  data.success = null;
  data.task = null;
  data.workNotes = [];
  data.canEdit = false;

  // Get task id from URL parameter or from input
  var taskId = $sp.getParameter('task_id');
  if (!taskId && input && input.task_id)
    taskId = input.task_id;

  gs.info('Task ID: ' + taskId);

  /**
   * Build task object for client
   */
  function buildTaskData(gr) {
    return {
      sys_id: gr.getUniqueValue(),
      number: gr.getValue('number'),
      short_description: gr.getValue('short_description'),
      description: gr.getValue('description'),
      state_value: gr.getValue('state'),           // '100','200','300','400'
      state_display: gr.getDisplayValue('state'),  // Pending, In Progress, Completed, Cancelled
      priority: gr.getValue('priority'),           // Low, Medium, High, Critical
      assigned_to: gr.getDisplayValue('assigned_to'),
      assigned_to_id: gr.getValue('assigned_to')
    };
  }

  /**
   * Load work notes from sys_journal_field
   * Using correct query parameters with element_id
   */
  function loadWorkNotes(taskSysId) {
    gs.info('');
    gs.info('=== LOADING WORK NOTES ===');
    gs.info('Task SysId: ' + taskSysId);
    
    var notes = [];
    var j = new GlideRecord('sys_journal_field');
    
    gs.info('Query Parameters:');
    gs.info('  name: x_1865669_retrospe_retrospective_task');
    gs.info('  element: work_notes');
    gs.info('  element_id: ' + taskSysId);
    
    // CORRECT QUERY PARAMETERS:
    j.addQuery('name', 'x_1865669_retrospe_retrospective_task');  // Table name
    j.addQuery('element', 'work_notes');          // Field name
    j.addQuery('element_id', taskSysId);         // Record ID (task sys_id)
    j.orderByDesc('sys_created_on');              // Newest first
    
    gs.info('Executing query...');
    j.query();

    var count = j.getRowCount();
    gs.info('Query Result: ' + count + ' work notes found');

    if (count == 0) {
      gs.warn('⚠ NO WORK NOTES FOUND - Check if:');
      gs.warn('  1. Task has work notes added');
      gs.warn('  2. element_id matches task sys_id');
      gs.warn('  3. Table name is correct');
    }

    var index = 0;
    while (j.next()) {
      index++;
      var sys_id = j.getUniqueValue();
      var author = j.getDisplayValue('sys_created_by');
      var value = j.getValue('value');
      var created_on = j.getValue('sys_created_on');
      
      gs.info('');
      gs.info('Work Note #' + index);
      gs.info('  sys_id: ' + sys_id);
      gs.info('  author: ' + author);
      gs.info('  value: ' + value.substring(0, 80));
      gs.info('  created_on: ' + created_on);
      
      notes.push({
        sys_id: sys_id,
        author: author,
        value: value,
        created_on: created_on
      });
    }
    
    gs.info('');
    gs.info('Total work notes returned: ' + notes.length);
    gs.info('=== END WORK NOTES ===');
    
    return notes;
  }

  /**
   * Load comments from sys_journal_field
   */
  function loadComments(taskSysId) {
    gs.info('Loading comments for task: ' + taskSysId);
    
    var notes = [];
    var j = new GlideRecord('sys_journal_field');
    
    j.addQuery('name', 'x_1865669_retrospe_retrospective_task');  // Table name
    j.addQuery('element', 'comments');            // Field name
    j.addQuery('element_id', taskSysId);         // Record ID
    j.orderByDesc('sys_created_on');
    j.query();

    var count = j.getRowCount();
    gs.info('Found ' + count + ' comments');

    while (j.next()) {
      notes.push({
        sys_id: j.getUniqueValue(),
        author: j.getDisplayValue('sys_created_by'),
        value: j.getValue('value'),
        created_on: j.getValue('sys_created_on')
      });
    }
    
    return notes;
  }

  /**
   * Combine work notes and comments
   */
  function loadAllNotes(taskSysId) {
    var allNotes = [];
    
    // Load work notes
    var workNotes = loadWorkNotes(taskSysId);
    allNotes = allNotes.concat(workNotes);
    
    // Load comments
    var comments = loadComments(taskSysId);
    allNotes = allNotes.concat(comments);
    
    // Sort by created date (newest first)
    allNotes.sort(function(a, b) {
      var dateA = new Date(a.created_on).getTime();
      var dateB = new Date(b.created_on).getTime();
      return dateB - dateA;
    });
    
    gs.info('Total notes (work notes + comments): ' + allNotes.length);
    
    return allNotes;
  }

  // ========== HANDLE SAVE FROM CLIENT ==========
  if (input && input.action === 'save') {
    gs.info('=== SAVE ACTION ===');
    
    if (!input.task_id) {
      data.error = 'Task ID is required';
      return;
    }

    taskId = input.task_id;
    var t = new GlideRecord('x_1865669_retrospe_retrospective_task');

    if (!t.get(taskId)) {
      data.error = 'Task not found';
      gs.warn('Task not found: ' + taskId);
      return;
    }

    gs.info('Task found: ' + t.getValue('number'));

    if (!t.canWrite()) {
      data.error = 'You do not have permission to update this task';
      return;
    }

    var currentState = t.getValue('state');
    var isLocked = (currentState == '300' || currentState == '400');
    
    gs.info('Current state: ' + currentState + ' | Locked: ' + isLocked);

    try {
      // 1) Validate and update State
      if (input.state) {
        var validStates = ['100', '200', '300', '400'];
        if (validStates.indexOf(input.state) === -1) {
          data.error = 'Invalid state value';
          return;
        }
        t.setValue('state', input.state);
        gs.info('State updated to: ' + input.state);
      }

      // 2) Update Priority
      if (input.priority) {
        var validPriorities = ['Low', 'Medium', 'High', 'Critical'];
        if (validPriorities.indexOf(input.priority) !== -1) {
          t.setValue('priority', input.priority);
          gs.info('Priority updated to: ' + input.priority);
        }
      }

      // 3) Short description + description (only if not locked)
      if (!isLocked) {
        if (input.short_description && input.short_description.trim()) {
          t.setValue('short_description', input.short_description.trim());
          gs.info('Short description updated');
        }

        if (input.description !== undefined) {
          t.setValue('description', input.description);
          gs.info('Description updated');
        }
      }

      // 4) Assigned to (if provided)
      if (input.assigned_to_id) {
        t.setValue('assigned_to', input.assigned_to_id);
        gs.info('Assigned to updated');
      }

      // 5) Work note (creates journal entry)
      if (input.work_note && input.work_note.trim()) {
        gs.info('');
        gs.info('=== ADDING WORK NOTE ===');
        gs.info('Input work_note: ' + input.work_note);
        gs.info('Trimmed: ' + input.work_note.trim());
        t.work_notes = input.work_note.trim();
				t.update();
        //t.setValue('work_notes', input.work_note.trim());
        gs.info('✓ Work note set on task record');
      } else {
        gs.warn('⚠ No work note provided or empty');
        gs.warn('  input.work_note: ' + input.work_note);
      }

      // Save changes
      t.update();
      gs.info('✓ Task updated: ' + t.getValue('number'));

      // Return updated task data
      data.task = buildTaskData(t);
      
      gs.info('');
      gs.info('=== RELOADING DATA AFTER SAVE ===');
      
      data.workNotes = loadAllNotes(t.getUniqueValue());
      
      gs.info('');
      gs.info('Reloaded work notes count: ' + data.workNotes.length);
      
      if (data.workNotes.length === 0) {
        gs.warn('⚠ WARNING: No work notes found after save!');
        gs.warn('  Check if work_notes field was actually saved');
        
        // Debug: Check raw field value
        var debugTask = new GlideRecord('x_1865669_retrospe_retrospective_task');
        debugTask.get(t.getUniqueValue());
        var rawWorkNotes = debugTask.getValue('work_notes');
        gs.info('Raw work_notes field value: ' + rawWorkNotes);
      }
      
      data.canEdit = t.canWrite();
      data.success = 'Task updated successfully';
      
      gs.info('Data prepared for client');

    } catch (e) {
      data.error = 'Error updating task: ' + e.message;
      gs.error('Exception in Retro Task Details Widget: ' + e.message);
    }

    return;
  }

  // ========== INITIAL LOAD ==========
  gs.info('=== INITIAL LOAD ===');
  
  if (!taskId) {
    data.error = 'No task ID provided in URL';
    return;
  }

  var gr = new GlideRecord('x_1865669_retrospe_retrospective_task');

  if (!gr.get(taskId)) {
    data.error = 'Task not found';
    gs.warn('Task not found: ' + taskId);
    return;
  }

  if (!gr.canRead()) {
    data.error = 'You do not have permission to view this task';
    return;
  }

  // Build initial data
  data.task = buildTaskData(gr);
  data.workNotes = loadAllNotes(taskId);
  data.canEdit = gr.canWrite();

  gs.info('✓ Task loaded: ' + gr.getValue('number'));
  gs.info('Work notes loaded: ' + data.workNotes.length);

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-09 09:13:41</sys_created_on>
        <sys_id>66e02bc48375361089529370ceaad38c</sys_id>
        <sys_mod_count>70</sys_mod_count>
        <sys_name>Retro task details</sys_name>
        <sys_package display_value="Retrospective Management" source="x_1865669_retrospe">fe15f7248365fa5089529370ceaad3a1</sys_package>
        <sys_policy/>
        <sys_scope display_value="Retrospective Management">fe15f7248365fa5089529370ceaad3a1</sys_scope>
        <sys_update_name>sp_widget_66e02bc48375361089529370ceaad38c</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-12-10 14:55:00</sys_updated_on>
        <template><![CDATA[<div class="panel panel-default" ng-if="data.task">
  <!-- Error/Success Messages -->
  <div ng-if="data.error" class="alert alert-danger">
    <i class="fa fa-exclamation-circle"></i>
    {{data.error}}
    <button type="button" class="close" ng-click="data.error = null">×</button>
  </div>

  <div ng-if="data.success" class="alert alert-success">
    <i class="fa fa-check-circle"></i>
    {{data.success}}
  </div>

  <!-- Header -->
  <div class="panel-heading clearfix">
    <div class="pull-left">
      <h3 class="panel-title m-t-none m-b-xs">
        <i class="fa fa-tasks"></i>
        {{data.task.number}} - {{data.task.short_description}}
      </h3>
      <div class="text-muted small">
        <i class="fa fa-user"></i>
        {{data.task.assigned_to || 'Unassigned'}}
        &nbsp;|&nbsp;
        <i class="fa fa-info-circle"></i>
        {{data.task.state_display || 'Pending'}}
        &nbsp;|&nbsp;
        <i class="fa fa-flag"></i>
        {{data.task.priority_display || data.task.priority || '-'}}
      </div>
    </div>

    <div class="pull-right btn-group">
      <button class="btn btn-default btn-sm" ng-click="c.goBack()">
        <i class="fa fa-arrow-left"></i> Back
      </button>

      <button class="btn btn-primary btn-sm"
              ng-if="!c.isEditMode && data.canEdit"
              ng-click="c.enterEditMode()">
        <i class="fa fa-pencil"></i> Edit
      </button>

      <button class="btn btn-default btn-sm"
              ng-if="c.isEditMode"
              ng-click="c.cancelEdit()">
        <i class="fa fa-times"></i> Cancel
      </button>

      <button class="btn btn-success btn-sm"
              ng-if="c.isEditMode"
              ng-click="c.save()"
              ng-disabled="c.saving">
        <i class="fa fa-save" ng-if="!c.saving"></i>
        <i class="fa fa-spinner fa-spin" ng-if="c.saving"></i>
        {{c.saving ? 'Saving...' : 'Save'}}
      </button>
    </div>
  </div>

  <!-- VIEW MODE -->
  <div class="panel-body" ng-if="!c.isEditMode">
    <div class="row">
      <!-- Task details -->
      <div class="col-md-7">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title m-t-none">
              <i class="fa fa-info-circle"></i>
              Task details
            </h4>
          </div>
          <div class="panel-body p-b-none">
            <dl class="dl-horizontal m-b-none">
              <dt>Number</dt>
              <dd>{{data.task.number}}</dd>

              <dt>State</dt>
              <dd>{{data.task.state_display || 'Pending'}}</dd>

              <dt>Assigned to</dt>
              <dd>{{data.task.assigned_to || 'Unassigned'}}</dd>

              <dt>Priority</dt>
              <dd>{{data.task.priority_display || data.task.priority || '-'}}</dd>
            </dl>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title m-t-none">
              <i class="fa fa-align-left"></i>
              Description
            </h4>
          </div>
          <div class="panel-body">
            <p ng-if="data.task.description" class="m-b-none">
              {{data.task.description}}
            </p>
            <p ng-if="!data.task.description"
               class="text-muted font-italic m-b-none">
              No description provided.
            </p>
          </div>
        </div>
      </div>

      <!-- Work notes -->
      <div class="col-md-5">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title m-t-none">
              <i class="fa fa-sticky-note"></i>
              Work notes
            </h4>
          </div>
          <div class="panel-body">
            <div ng-if="!data.workNotes || !data.workNotes.length"
                 class="text-muted text-center">
              <i class="fa fa-sticky-note-o fa-2x m-b-sm"></i>
              <p class="m-b-none">No work notes yet.</p>
            </div>

            <div ng-if="data.workNotes && data.workNotes.length">
              <div class="well well-sm m-b-sm"
                   ng-repeat="note in data.workNotes">
                <div class="clearfix m-b-xs">
                  <strong>{{note.author || 'Unknown'}}</strong>
                  <span class="pull-right text-muted small">
                    {{note.created_on | date:'MMM d, yyyy HH:mm'}}
                  </span>
                </div>
                <div class="small" style="white-space: pre-wrap;">
                  {{note.value}}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EDIT MODE -->
  <div class="panel-body" ng-if="c.isEditMode">
    <div class="row">
      <!-- Left: Basic fields -->
      <div class="col-md-7">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title m-t-none">
              <i class="fa fa-edit"></i>
              Edit task
            </h4>
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-sm-6">
                <div class="form-group">
                  <label>State</label>
                  <select class="form-control" ng-model="c.form.state">
                    <option value="100">Pending</option>
                    <option value="200">In Progress</option>
                    <option value="300">Completed</option>
                    <option value="400">Cancelled</option>
                  </select>
                </div>
              </div>

              <div class="col-sm-6">
                <div class="form-group">
                  <label>Priority</label>
                  <select class="form-control" ng-model="c.form.priority">
                    <option value="1">Low</option>
                    <option value="2">Medium</option>
                    <option value="3">High</option>
                    <option value="4">Critical</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Short description</label>
              <input type="text"
                     class="form-control"
                     ng-model="c.form.short_description"
                     ng-disabled="data.task.state_value == '300' || data.task.state_value == '400'"
                     required>
            </div>

            <div class="form-group">
              <label>Description</label>
              <textarea class="form-control"
                        rows="5"
                        ng-model="c.form.description"
                        ng-disabled="data.task.state_value == '300' || data.task.state_value == '400'">
              </textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Add work note -->
      <div class="col-md-5">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title m-t-none">
              <i class="fa fa-comment"></i>
              Add work note
            </h4>
          </div>
          <div class="panel-body">
            <div class="form-group m-b-none">
              <textarea class="form-control"
                        rows="10"
                        ng-model="c.form.work_note"
                        placeholder="Add a work note to track your progress...">
              </textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error-only state when no task -->
<div ng-if="data.error && !data.task" class="alert alert-danger">
  <i class="fa fa-exclamation-triangle"></i>
  <span>{{data.error}}</span>
</div>]]></template>
    </sp_widget>
</record_update>
