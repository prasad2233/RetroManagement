<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $window, $timeout) {
  var c = this;

  console.log('=== Retro Task Details Widget Loaded ===');
  console.log('Task:', $scope.data.task);
  console.log('Can Edit:', $scope.data.canEdit);

  // ============== STATE ==============
  c.isEditMode = false;
  c.form = {};
  c.saving = false;

  // ============== INITIALIZATION ==============
  c.initialize = function() {
    if ($scope.data.task) {
      c.form = {
        state: $scope.data.task.state_value || '100',          // '100','200','300','400'
        short_description: $scope.data.task.short_description || '',
        description: $scope.data.task.description || '',
        priority: $scope.data.task.priority || 'Medium',
        work_note: ''
      };
    }
  };

  c.initialize();

  // ============== NAVIGATION ==============
  c.goBack = function() {
    console.log('Going back');
    $window.history.back();
  };

  // ============== EDIT MODE ==============
  c.enterEditMode = function() {
    console.log('Entering edit mode');

    if (!$scope.data.task || !$scope.data.canEdit)
      return;

    c.isEditMode = true;
    c.form = {
      state: $scope.data.task.state_value || '100',
      short_description: $scope.data.task.short_description || '',
      description: $scope.data.task.description || '',
      priority: $scope.data.task.priority || 'Medium',
      work_note: ''
    };
    $scope.data.error = null;
    $scope.data.success = null;
  };

  c.cancelEdit = function() {
    console.log('Canceling edit mode');
    c.isEditMode = false;
    c.form = {};
    $scope.data.error = null;
    $scope.data.success = null;
  };

  // ============== SAVE TASK ==============
  c.save = function() {
    if (!$scope.data.task || !$scope.data.task.sys_id)
      return;

    // Validate
    if (!c.form.short_description || !c.form.short_description.trim()) {
      $scope.data.error = 'Task title is required';
      return;
    }

    c.saving = true;
    $scope.data.error = null;
    $scope.data.success = null;

    console.log('Saving task with updates:', c.form);

    // Prepare payload for server (becomes `input`)
    $scope.data.action            = 'save';
    $scope.data.task_id           = $scope.data.task.sys_id;
    $scope.data.state             = c.form.state;
    $scope.data.short_description = c.form.short_description.trim();
    $scope.data.description       = c.form.description;
    $scope.data.priority          = c.form.priority;
    $scope.data.work_note         = c.form.work_note;

    c.server.update($scope.data).then(function(response) {
      c.saving = false;

      var res = response.data;   // server script returns data directly

      console.log('Server response:', res);

      if (!res) {
        $scope.data.error = 'No response from server';
        return;
      }

      if (res.error) {
        console.error('✗ Error:', res.error);
        $scope.data.error = res.error || 'Failed to save task';
        return;
      }

      // Success path
      console.log('✓ Task saved successfully');

      if (res.task)
        $scope.data.task = res.task;

      if (res.workNotes)
        $scope.data.workNotes = res.workNotes;

      $scope.data.success = res.success || 'Task updated successfully';

      // Exit edit mode and refresh form
      c.isEditMode = false;
      c.form = {
        state: $scope.data.task.state_value || '100',
        short_description: $scope.data.task.short_description || '',
        description: $scope.data.task.description || '',
        priority: $scope.data.task.priority || 'Medium',
        work_note: ''
      };

      // Auto-hide success message after 4 seconds
      $timeout(function() {
        $scope.data.success = null;
      }, 4000);

      // Optional: clear transient payload fields
      $scope.data.action = null;
      $scope.data.task_id = null;
      $scope.data.state = null;
      $scope.data.short_description = null;
      $scope.data.description = null;
      $scope.data.priority = null;
      $scope.data.work_note = null;

    }).catch(function(error) {
      c.saving = false;
      console.error('✗ Server error:', error);
      $scope.data.error = 'Failed to save task. Please try again.';
    });
  };

  // ============== WATCHERS ==============
  $scope.$watch('data.task', function(newVal) {
    if (newVal) {
      console.log('Task data changed:', newVal);
      c.initialize();
    }
  }, true);

  $scope.$watch('data.error', function(newVal) {
    if (newVal) {
      console.log('Error:', newVal);
    }
  });
}]]></client_script>
        <controller_as>c</controller_as>
        <css>/* Page background similar to retro widgets */
.retro-page-bg {
  background: radial-gradient(circle at top left, #667eea 0, #4c51bf 40%, #1f2937 100%);
  padding: 32px 16px;
}

/* Container */
.retro-task-container {
  max-width: 1100px;
  margin: 0 auto;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* Top bar */
.retro-top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
  gap: 12px;
}

/* Back button */
.back-button {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.25);
  background: rgba(15, 23, 42, 0.6);
  color: #e5e7eb;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.back-button i {
  font-size: 11px;
}

.back-button:hover {
  background: rgba(129, 140, 248, 0.9);
  border-color: transparent;
  color: #f9fafb;
}

/* Sprint chip */
.sprint-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 999px;
  background: rgba(129, 140, 248, 0.1);
  border: 1px solid rgba(129, 140, 248, 0.6);
  color: #e5e7eb;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.sprint-chip i {
  font-size: 11px;
}

/* Alerts */
.alert {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  border-radius: 10px;
  margin-bottom: 12px;
  font-size: 12px;
  animation: fadeInDown 0.2s ease-out;
}

.alert i {
  font-size: 15px;
}

.alert-error {
  background: rgba(248, 113, 113, 0.1);
  color: #fecaca;
  border: 1px solid #fecaca;
}

.alert-success {
  background: rgba(52, 211, 153, 0.12);
  color: #bbf7d0;
  border: 1px solid #6ee7b7;
}

/* Cards */
.task-card {
  background: #0b1120;
  border-radius: 18px;
  box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
  border: 1px solid rgba(148, 163, 184, 0.3);
  backdrop-filter: blur(18px);
}

.task-card--header {
  padding: 18px 22px 14px;
  margin-bottom: 10px;
}

.task-card--body {
  padding: 22px 22px 12px;
}

.task-card--footer {
  margin-top: 8px;
  padding: 10px 18px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Header content */
.task-header-main {
  display: flex;
  justify-content: space-between;
  gap: 20px;
  align-items: flex-start;
}

.task-header-left {
  flex: 1;
  min-width: 0;
}

.task-pill {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 4px 12px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(148, 163, 184, 0.7);
  margin-bottom: 6px;
}

.task-pill-label {
  font-size: 10px;
  text-transform: uppercase;
  color: #9ca3af;
  letter-spacing: 0.12em;
}

.task-pill-number {
  font-size: 11px;
  color: #e5e7eb;
  font-weight: 600;
}

.task-title {
  font-size: 22px;
  line-height: 1.3;
  color: #f9fafb;
  margin: 4px 0 10px;
  word-break: break-word;
}

.task-meta-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.meta-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  color: #e5e7eb;
  background: rgba(15, 23, 42, 0.85);
  border: 1px solid rgba(148, 163, 184, 0.5);
}

.meta-chip i {
  font-size: 11px;
  color: #a5b4fc;
}

.task-header-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
}

/* State badge + priority chip */
.state-badge {
  padding: 4px 12px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  text-transform: capitalize;
  white-space: nowrap;
}

.state-badge--Completed {
  background: rgba(34, 197, 94, 0.12);
  color: #bbf7d0;
  border: 1px solid rgba(34, 197, 94, 0.6);
}

.state-badge--In_Progress {
  background: rgba(234, 179, 8, 0.12);
  color: #facc15;
  border: 1px solid rgba(234, 179, 8, 0.7);
}

.state-badge--Not_Started {
  background: rgba(100, 116, 139, 0.18);
  color: #e5e7eb;
  border: 1px solid rgba(148, 163, 184, 0.7);
}

.priority-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 500;
}

.priority-pill i {
  font-size: 11px;
}

.priority-pill--Low {
  background: rgba(34, 197, 94, 0.1);
  color: #bbf7d0;
}

.priority-pill--Medium {
  background: rgba(59, 130, 246, 0.12);
  color: #bfdbfe;
}

.priority-pill--High {
  background: rgba(251, 191, 36, 0.12);
  color: #facc15;
}

.priority-pill--Critical {
  background: rgba(248, 113, 113, 0.12);
  color: #fecaca;
}

/* Body layout */
.task-layout {
  display: grid;
  grid-template-columns: 1.6fr 1fr;
  gap: 22px;
}

.edit-layout {
  display: block;
}

/* Sections */
.section-block {
  margin-bottom: 18px;
}

.section-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}

.section-header h2 {
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.18em;
  color: #9ca3af;
}

.section-dot {
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: #60a5fa;
}

.section-tag {
  margin-left: auto;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: #a5b4fc;
  background: rgba(79, 70, 229, 0.18);
  border-radius: 999px;
  padding: 2px 8px;
}

.section-tag--accent {
  color: #fbbf24;
  background: rgba(251, 191, 36, 0.12);
}

/* Description */
.description-box {
  background: radial-gradient(circle at top left, rgba(79, 70, 229, 0.22), rgba(15, 23, 42, 0.95));
  border-radius: 14px;
  padding: 14px 16px;
  font-size: 13px;
  color: #e5e7eb;
  line-height: 1.6;
  border: 1px solid rgba(129, 140, 248, 0.3);
  box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.7);
  white-space: pre-wrap;
  word-break: break-word;
}

.description-box--empty {
  color: #6b7280;
  font-style: italic;
}

/* Notes */
.notes-container {
  border-radius: 12px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid rgba(31, 41, 55, 0.9);
  padding: 10px 10px 4px;
  max-height: 260px;
  overflow: auto;
}

.note-item {
  background: rgba(15, 23, 42, 0.9);
  border-radius: 10px;
  padding: 8px 10px;
  border: 1px solid rgba(51, 65, 85, 0.9);
  margin-bottom: 8px;
}

.note-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.note-author-block {
  display: flex;
  align-items: center;
  gap: 8px;
}

.note-avatar {
  width: 26px;
  height: 26px;
  border-radius: 999px;
  background: linear-gradient(135deg, #22d3ee, #818cf8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  color: #0f172a;
}

.note-author-meta {
  display: flex;
  flex-direction: column;
}

.note-author-name {
  font-size: 12px;
  color: #e5e7eb;
  font-weight: 500;
}

.note-date {
  font-size: 10px;
  color: #9ca3af;
}

.note-content {
  font-size: 12px;
  color: #cbd5f5;
  white-space: pre-wrap;
  word-break: break-word;
}

.empty-notes {
  text-align: center;
  padding: 20px 8px;
  color: #6b7280;
  font-size: 12px;
}

.empty-notes i {
  display: block;
  font-size: 20px;
  margin-bottom: 4px;
}

/* Detail list (side column) */
.detail-list {
  margin: 0;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  padding: 6px 0;
  border-bottom: 1px dashed rgba(31, 41, 55, 0.9);
}

.detail-row:last-child {
  border-bottom: none;
}

.detail-row dt {
  font-size: 11px;
  color: #9ca3af;
  text-transform: uppercase;
  letter-spacing: 0.12em;
}

.detail-row dd {
  margin: 0;
  font-size: 12px;
  color: #e5e7eb;
  text-align: right;
}

/* State chip in detail list */
.state-chip {
  padding: 2px 10px;
  border-radius: 999px;
  font-size: 11px;
}

.state-chip--Completed {
  background: rgba(34, 197, 94, 0.12);
  color: #bbf7d0;
}

.state-chip--In_Progress {
  background: rgba(234, 179, 8, 0.12);
  color: #facc15;
}

.state-chip--Not_Started {
  background: rgba(100, 116, 139, 0.25);
  color: #e5e7eb;
}

/* Forms */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 14px 16px;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.form-field--full {
  margin-top: 12px;
}

.form-field label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: #9ca3af;
}

.form-input,
.form-select,
.form-textarea {
  background: rgba(15, 23, 42, 0.96);
  border-radius: 10px;
  border: 1px solid rgba(55, 65, 81, 0.9);
  padding: 8px 10px;
  font-size: 12px;
  color: #e5e7eb;
  outline: none;
  transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  border-color: #818cf8;
  box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
  background: rgba(15, 23, 42, 0.98);
}

.form-textarea {
  resize: vertical;
  min-height: 110px;
}

/* Footer */
.footer-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.footer-id-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: #6b7280;
}

.footer-id-value {
  font-size: 11px;
  color: #9ca3af;
  font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

.footer-actions {
  display: flex;
  gap: 8px;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  border: none;
  cursor: pointer;
  transition: all 0.15s ease;
}

.btn i {
  font-size: 11px;
}

.btn-primary {
  background: linear-gradient(135deg, #4f46e5, #818cf8);
  color: #f9fafb;
  box-shadow: 0 8px 20px rgba(79, 70, 229, 0.45);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 10px 24px rgba(79, 70, 229, 0.6);
}

.btn-secondary {
  background: rgba(15, 23, 42, 0.9);
  color: #e5e7eb;
  border: 1px solid rgba(148, 163, 184, 0.7);
}

.btn-secondary:hover {
  background: rgba(15, 23, 42, 0.98);
}

.btn-success {
  background: linear-gradient(135deg, #22c55e, #4ade80);
  color: #052e16;
}

.btn-success:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);
}

.btn-ghost {
  background: transparent;
  color: #9ca3af;
  border: 1px dashed rgba(75, 85, 99, 0.9);
}

.btn-ghost:hover {
  background: rgba(15, 23, 42, 0.9);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Error box (fallback) */
.error-box {
  background: rgba(248, 113, 113, 0.16);
  border-radius: 14px;
  padding: 26px 20px;
  border: 1px solid rgba(248, 113, 113, 0.5);
  text-align: center;
  color: #fecaca;
}

.error-box i {
  display: block;
  font-size: 28px;
  margin-bottom: 8px;
}

/* Animations */
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(-8px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 900px) {
  .task-layout {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 640px) {
  .retro-page-bg {
    padding: 20px 10px;
  }

  .task-card--header,
  .task-card--body {
    padding: 16px 14px;
  }

  .task-header-main {
    flex-direction: column;
    gap: 10px;
  }

  .task-title {
    font-size: 18px;
  }

  .footer-actions {
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .btn {
    font-size: 10px;
    padding: 6px 10px;
  }

  .btn i {
    display: none;
  }
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>retro_task_details</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Retro task details</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  gs.info('=== Retro Task Details Widget ===');

  data.error = null;
  data.success = null;
  data.task = null;
  data.workNotes = [];
  data.canEdit = false;

  // Get task id from URL parameter or from input
  var taskId = $sp.getParameter('task_id');
  if (!taskId && input && input.task_id)
    taskId = input.task_id;

  gs.info('Task ID: ' + taskId);

  /**
   * Build task object for client
   */
  function buildTaskData(gr) {
    return {
      sys_id: gr.getUniqueValue(),
      number: gr.getValue('number'),
      short_description: gr.getValue('short_description'),
      description: gr.getValue('description'),
      state_value: gr.getValue('state'),           // '100','200','300','400'
      state_display: gr.getDisplayValue('state'),  // Pending, In Progress, Completed, Cancelled
      priority: gr.getValue('priority'),           // Low, Medium, High, Critical
      assigned_to: gr.getDisplayValue('assigned_to'),
      assigned_to_id: gr.getValue('assigned_to')
    };
  }

  /**
   * Load work notes from sys_journal_field
   * Using correct query parameters with element_id
   */
  function loadWorkNotes(taskSysId) {
    gs.info('');
    gs.info('=== LOADING WORK NOTES ===');
    gs.info('Task SysId: ' + taskSysId);
    
    var notes = [];
    var j = new GlideRecord('sys_journal_field');
    
    gs.info('Query Parameters:');
    gs.info('  name: x_1865669_retrospe_retrospective_task');
    gs.info('  element: work_notes');
    gs.info('  element_id: ' + taskSysId);
    
    // CORRECT QUERY PARAMETERS:
    j.addQuery('name', 'x_1865669_retrospe_retrospective_task');  // Table name
    j.addQuery('element', 'work_notes');          // Field name
    j.addQuery('element_id', taskSysId);         // Record ID (task sys_id)
    j.orderByDesc('sys_created_on');              // Newest first
    
    gs.info('Executing query...');
    j.query();

    var count = j.getRowCount();
    gs.info('Query Result: ' + count + ' work notes found');

    if (count == 0) {
      gs.warn('⚠ NO WORK NOTES FOUND - Check if:');
      gs.warn('  1. Task has work notes added');
      gs.warn('  2. element_id matches task sys_id');
      gs.warn('  3. Table name is correct');
    }

    var index = 0;
    while (j.next()) {
      index++;
      var sys_id = j.getUniqueValue();
      var author = j.getDisplayValue('sys_created_by');
      var value = j.getValue('value');
      var created_on = j.getValue('sys_created_on');
      
      gs.info('');
      gs.info('Work Note #' + index);
      gs.info('  sys_id: ' + sys_id);
      gs.info('  author: ' + author);
      gs.info('  value: ' + value.substring(0, 80));
      gs.info('  created_on: ' + created_on);
      
      notes.push({
        sys_id: sys_id,
        author: author,
        value: value,
        created_on: created_on
      });
    }
    
    gs.info('');
    gs.info('Total work notes returned: ' + notes.length);
    gs.info('=== END WORK NOTES ===');
    
    return notes;
  }

  /**
   * Load comments from sys_journal_field
   */
  function loadComments(taskSysId) {
    gs.info('Loading comments for task: ' + taskSysId);
    
    var notes = [];
    var j = new GlideRecord('sys_journal_field');
    
    j.addQuery('name', 'x_1865669_retrospe_retrospective_task');  // Table name
    j.addQuery('element', 'comments');            // Field name
    j.addQuery('element_id', taskSysId);         // Record ID
    j.orderByDesc('sys_created_on');
    j.query();

    var count = j.getRowCount();
    gs.info('Found ' + count + ' comments');

    while (j.next()) {
      notes.push({
        sys_id: j.getUniqueValue(),
        author: j.getDisplayValue('sys_created_by'),
        value: j.getValue('value'),
        created_on: j.getValue('sys_created_on')
      });
    }
    
    return notes;
  }

  /**
   * Combine work notes and comments
   */
  function loadAllNotes(taskSysId) {
    var allNotes = [];
    
    // Load work notes
    var workNotes = loadWorkNotes(taskSysId);
    allNotes = allNotes.concat(workNotes);
    
    // Load comments
    var comments = loadComments(taskSysId);
    allNotes = allNotes.concat(comments);
    
    // Sort by created date (newest first)
    allNotes.sort(function(a, b) {
      var dateA = new Date(a.created_on).getTime();
      var dateB = new Date(b.created_on).getTime();
      return dateB - dateA;
    });
    
    gs.info('Total notes (work notes + comments): ' + allNotes.length);
    
    return allNotes;
  }

  // ========== HANDLE SAVE FROM CLIENT ==========
  if (input && input.action === 'save') {
    gs.info('=== SAVE ACTION ===');
    
    if (!input.task_id) {
      data.error = 'Task ID is required';
      return;
    }

    taskId = input.task_id;
    var t = new GlideRecord('x_1865669_retrospe_retrospective_task');

    if (!t.get(taskId)) {
      data.error = 'Task not found';
      gs.warn('Task not found: ' + taskId);
      return;
    }

    gs.info('Task found: ' + t.getValue('number'));

    if (!t.canWrite()) {
      data.error = 'You do not have permission to update this task';
      return;
    }

    var currentState = t.getValue('state');
    var isLocked = (currentState == '300' || currentState == '400');
    
    gs.info('Current state: ' + currentState + ' | Locked: ' + isLocked);

    try {
      // 1) Validate and update State
      if (input.state) {
        var validStates = ['100', '200', '300', '400'];
        if (validStates.indexOf(input.state) === -1) {
          data.error = 'Invalid state value';
          return;
        }
        t.setValue('state', input.state);
        gs.info('State updated to: ' + input.state);
      }

      // 2) Update Priority
      if (input.priority) {
        var validPriorities = ['Low', 'Medium', 'High', 'Critical'];
        if (validPriorities.indexOf(input.priority) !== -1) {
          t.setValue('priority', input.priority);
          gs.info('Priority updated to: ' + input.priority);
        }
      }

      // 3) Short description + description (only if not locked)
      if (!isLocked) {
        if (input.short_description && input.short_description.trim()) {
          t.setValue('short_description', input.short_description.trim());
          gs.info('Short description updated');
        }

        if (input.description !== undefined) {
          t.setValue('description', input.description);
          gs.info('Description updated');
        }
      }

      // 4) Assigned to (if provided)
      if (input.assigned_to_id) {
        t.setValue('assigned_to', input.assigned_to_id);
        gs.info('Assigned to updated');
      }

      // 5) Work note (creates journal entry)
      if (input.work_note && input.work_note.trim()) {
        gs.info('');
        gs.info('=== ADDING WORK NOTE ===');
        gs.info('Input work_note: ' + input.work_note);
        gs.info('Trimmed: ' + input.work_note.trim());
        
        t.setValue('work_notes', input.work_note.trim());
        gs.info('✓ Work note set on task record');
      } else {
        gs.warn('⚠ No work note provided or empty');
        gs.warn('  input.work_note: ' + input.work_note);
      }

      // Save changes
      t.update();
      gs.info('✓ Task updated: ' + t.getValue('number'));

      // Return updated task data
      data.task = buildTaskData(t);
      
      gs.info('');
      gs.info('=== RELOADING DATA AFTER SAVE ===');
      
      data.workNotes = loadAllNotes(t.getUniqueValue());
      
      gs.info('');
      gs.info('Reloaded work notes count: ' + data.workNotes.length);
      
      if (data.workNotes.length === 0) {
        gs.warn('⚠ WARNING: No work notes found after save!');
        gs.warn('  Check if work_notes field was actually saved');
        
        // Debug: Check raw field value
        var debugTask = new GlideRecord('x_1865669_retrospe_retrospective_task');
        debugTask.get(t.getUniqueValue());
        var rawWorkNotes = debugTask.getValue('work_notes');
        gs.info('Raw work_notes field value: ' + rawWorkNotes);
      }
      
      data.canEdit = t.canWrite();
      data.success = 'Task updated successfully';
      
      gs.info('Data prepared for client');

    } catch (e) {
      data.error = 'Error updating task: ' + e.message;
      gs.error('Exception in Retro Task Details Widget: ' + e.message);
    }

    return;
  }

  // ========== INITIAL LOAD ==========
  gs.info('=== INITIAL LOAD ===');
  
  if (!taskId) {
    data.error = 'No task ID provided in URL';
    return;
  }

  var gr = new GlideRecord('x_1865669_retrospe_retrospective_task');

  if (!gr.get(taskId)) {
    data.error = 'Task not found';
    gs.warn('Task not found: ' + taskId);
    return;
  }

  if (!gr.canRead()) {
    data.error = 'You do not have permission to view this task';
    return;
  }

  // Build initial data
  data.task = buildTaskData(gr);
  data.workNotes = loadAllNotes(taskId);
  data.canEdit = gr.canWrite();

  gs.info('✓ Task loaded: ' + gr.getValue('number'));
  gs.info('Work notes loaded: ' + data.workNotes.length);

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-09 09:13:41</sys_created_on>
        <sys_id>66e02bc48375361089529370ceaad38c</sys_id>
        <sys_mod_count>41</sys_mod_count>
        <sys_name>Retro task details</sys_name>
        <sys_package display_value="Retrospective Management" source="x_1865669_retrospe">fe15f7248365fa5089529370ceaad3a1</sys_package>
        <sys_policy/>
        <sys_scope display_value="Retrospective Management">fe15f7248365fa5089529370ceaad3a1</sys_scope>
        <sys_update_name>sp_widget_66e02bc48375361089529370ceaad38c</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-12-09 14:51:17</sys_updated_on>
        <template><![CDATA[<div class="retro-page-bg">
  <div class="retro-task-container" ng-if="!data.error && data.task">

    <!-- Top bar -->
    <div class="retro-top-bar">
      <button class="back-button" ng-click="c.goBack()">
        <i class="fa fa-arrow-left"></i>
        <span>Back</span>
      </button>

      <div class="sprint-chip">
        <i class="fa fa-clipboard-check"></i>
        <span>Retrospective Task</span>
      </div>
    </div>

    <!-- Alerts -->
    <div class="alert alert-error" ng-if="data.error">
      <i class="fa fa-exclamation-circle"></i>
      <span>{{data.error}}</span>
    </div>

    <div class="alert alert-success" ng-if="data.success">
      <i class="fa fa-check-circle"></i>
      <span>{{data.success}}</span>
    </div>

    <!-- Header card -->
    <div class="task-card task-card--header">
      <div class="task-header-main">
        <div class="task-header-left">
          <div class="task-pill">
            <span class="task-pill-label">TASK</span>
            <span class="task-pill-number">{{data.task.number}}</span>
          </div>
          <h1 class="task-title" ng-bind="data.task.short_description"></h1>

          <div class="task-meta-row">
            <div class="meta-chip">
              <i class="fa fa-user"></i>
              <span>{{data.task.assigned_to || 'Unassigned'}}</span>
            </div>
            <div class="meta-chip">
              <i class="fa fa-layer-group"></i>
              <span>Priority: {{data.task.priority || '-'}}</span>
            </div>
          </div>
        </div>

        <div class="task-header-right">
          <div class="state-badge"
               ng-class="'state-badge--' + (data.task.state_display || 'Pending').replace(' ', '_')">
            {{data.task.state_display || 'Pending'}}
          </div>
        </div>
      </div>
    </div>

    <!-- Body card -->
    <div class="task-card task-card--body">

      <!-- VIEW MODE -->
      <div class="task-layout" ng-if="!c.isEditMode">
        <div class="task-main-column">
          <!-- Summary block -->
          <section class="section-block">
            <div class="section-header">
              <h2>Summary</h2>
              <span class="section-dot"></span>
            </div>
            <dl class="detail-list">
              <div class="detail-row">
                <dt>Number</dt>
                <dd>{{data.task.number}}</dd>
              </div>
              <div class="detail-row">
                <dt>State</dt>
                <dd>
                  <span class="state-chip"
                        ng-class="'state-chip--' + (data.task.state_display || 'Pending').replace(' ', '_')">
                    {{data.task.state_display || 'Pending'}}
                  </span>
                </dd>
              </div>
              <div class="detail-row">
                <dt>Assigned To</dt>
                <dd>{{data.task.assigned_to || 'Unassigned'}}</dd>
              </div>
              <div class="detail-row">
                <dt>Priority</dt>
                <dd>
                  <span class="priority-pill"
                        ng-class="'priority-pill--' + (data.task.priority || 'Medium')">
                    {{data.task.priority || '-'}}
                  </span>
                </dd>
              </div>
              <div class="detail-row">
                <dt>Short Description</dt>
                <dd>{{data.task.short_description}}</dd>
              </div>
            </dl>
          </section>

          <!-- Description -->
          <section class="section-block">
            <div class="section-header">
              <h2>Description</h2>
              <span class="section-dot"></span>
            </div>
            <div class="description-box"
                 ng-class="{'description-box--empty': !data.task.description}">
              {{data.task.description || 'No description provided'}}
            </div>
          </section>
        </div>

        <!-- Work notes column -->
        <div class="task-side-column">
          <section class="section-block">
            <div class="section-header">
              <h2>Work Notes</h2>
              <span class="section-tag">History</span>
            </div>

            <div class="notes-container">
              <div class="note-item" ng-repeat="note in data.workNotes">
                <div class="note-header">
                  <div class="note-author-block">
                    <div class="note-avatar">
                      {{(note.author || '?') | limitTo:1 | uppercase}}
                    </div>
                    <div class="note-author-meta">
                      <span class="note-author-name">{{note.author || 'Unknown'}}</span>
                      <span class="note-date">
                        {{note.created_on | date:'MMM d, yyyy HH:mm'}}
                      </span>
                    </div>
                  </div>
                </div>
                <div class="note-content">{{note.value}}</div>
              </div>

              <div class="empty-notes" ng-if="!data.workNotes || !data.workNotes.length">
                <i class="fa fa-sticky-note"></i>
                <p>No work notes yet</p>
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- EDIT MODE -->
      <div class="edit-layout" ng-if="c.isEditMode">
        <form novalidate>
          <section class="section-block">
            <div class="section-header">
              <h2>Edit Task</h2>
              <span class="section-tag section-tag--accent">Update</span>
            </div>

            <!-- State & Priority -->
            <div class="form-grid">
              <div class="form-field">
                <label>State</label>
                <select class="form-select" ng-model="c.form.state">
                  <option value="100">Pending</option>
                  <option value="200">In Progress</option>
                  <option value="300">Completed</option>
                  <option value="400">Cancelled</option>
                </select>
              </div>

              <div class="form-field">
                <label>Priority</label>
                <select class="form-select" ng-model="c.form.priority">
                  <option value="Low">Low</option>
                  <option value="Medium">Medium</option>
                  <option value="High">High</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
            </div>

            <!-- Short description (locked if Completed/Cancelled) -->
            <div class="form-field form-field--full">
              <label>Short Description</label>
              <input type="text"
                     class="form-input"
                     ng-model="c.form.short_description"
                     ng-disabled="data.task.state_value == '300' || data.task.state_value == '400'"
                     required>
            </div>

            <!-- Description (locked if Completed/Cancelled) -->
            <div class="form-field form-field--full">
              <label>Description</label>
              <textarea class="form-textarea"
                        rows="4"
                        ng-model="c.form.description"
                        ng-disabled="data.task.state_value == '300' || data.task.state_value == '400'">
              </textarea>
            </div>

            <!-- New work note -->
            <div class="form-field form-field--full">
              <label>Add Work Note</label>
              <textarea class="form-textarea"
                        rows="4"
                        ng-model="c.form.work_note"
                        placeholder="Add a work note..."></textarea>
            </div>
          </section>
        </form>
      </div>
    </div>

    <!-- Footer (buttons only) -->
    <div class="task-card task-card--footer">
      <div class="footer-actions">
        <button class="btn btn-secondary"
                ng-if="!c.isEditMode && data.canEdit"
                ng-click="c.enterEditMode()">
          <i class="fa fa-pen"></i>
          <span>Edit</span>
        </button>

        <button class="btn btn-ghost"
                ng-if="c.isEditMode"
                ng-click="c.cancelEdit()">
          <i class="fa fa-times"></i>
          <span>Cancel</span>
        </button>

        <button class="btn btn-primary"
                ng-if="c.isEditMode"
                ng-click="c.save()"
                ng-disabled="c.saving">
          <i class="fa fa-save" ng-if="!c.saving"></i>
          <i class="fa fa-spinner fa-spin" ng-if="c.saving"></i>
          <span ng-if="!c.saving">Save</span>
          <span ng-if="c.saving">Saving…</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Error-only state -->
  <div class="retro-task-container" ng-if="data.error && !data.task">
    <div class="error-box">
      <i class="fa fa-exclamation-triangle"></i>
      <p>{{data.error}}</p>
    </div>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
