<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, $window, $timeout) {
    var c = this;
    
    console.log('=== Dashboard Page Loaded ===');
    console.log('My Retros:', $scope.data.myRetros.length);
    console.log('Team Retros:', $scope.data.teamRetros.length);
    console.log('My Tasks:', $scope.data.myTasks.length);
    console.log('Team Tasks:', $scope.data.teamTasks.length);
    
    // Initialize state
    c.activeCard = null;
    c.loading = false;
    
    /**
     * Open retrospective details page
     * @param {string} sysId - Retrospective sys_id
     * @param {event} $event - Click event
     */
    c.openRetro = function(sysId, $event) {
        if ($event) {
            $event.preventDefault();
            $event.stopPropagation();
        }
        
        if (!sysId) {
            console.error('No retro ID provided');
            alert('Error: Unable to open retrospective');
            return;
        }
        
        console.log('Opening retrospective details:', sysId);
        c.loading = true;
        
        // Navigate to retro details page
        $timeout(function() {
            $window.location.href = '/sp?id=retro_details&retro_id=' + sysId;
        }, 300);
    };
    
    /**
     * Open task details page
     * @param {string} sysId - Task sys_id
     * @param {event} $event - Click event
     */
    c.openTask = function(sysId, $event) {
        if ($event) {
            $event.preventDefault();
            $event.stopPropagation();
        }
        
        if (!sysId) {
            console.error('No task ID provided');
            alert('Error: Unable to open task');
            return;
        }
        
        console.log('Opening task details:', sysId);
        c.loading = true;
        
        // Navigate to task details page
        $timeout(function() {
            $window.location.href = '/sp?id=retro_task_details&task_id=' + sysId;
        }, 300);
    };
    
    /**
     * Filter retrospectives by status
     * @param {string} status - Status to filter by
     */
    c.filterRetrosByStatus = function(status) {
        console.log('Filtering retros by status:', status);
        c.activeCard = status;
    };
    
    /**
     * Clear filters
     */
    c.clearFilters = function() {
        console.log('Clearing filters');
        c.activeCard = null;
    };
    
    /**
     * Get total count of items
     */
    c.getTotalCount = function() {
        var total = 0;
        if ($scope.data.myRetros) total += $scope.data.myRetros.length;
        if ($scope.data.teamRetros) total += $scope.data.teamRetros.length;
        if ($scope.data.myTasks) total += $scope.data.myTasks.length;
        if ($scope.data.teamTasks) total += $scope.data.teamTasks.length;
        return total;
    };
    
    /**
     * Log dashboard stats
     */
    c.logStats = function() {
        console.log('=== Dashboard Stats ===');
        console.log('My Retros: ' + $scope.data.myRetros.length);
        console.log('Team Retros: ' + $scope.data.teamRetros.length);
        console.log('My Tasks: ' + $scope.data.myTasks.length);
        console.log('Team Tasks: ' + $scope.data.teamTasks.length);
        console.log('Total Items: ' + c.getTotalCount());
    };
    
    // Expose functions to scope
    $scope.openRetro = c.openRetro;
    $scope.openTask = c.openTask;
    $scope.filterRetrosByStatus = c.filterRetrosByStatus;
    $scope.clearFilters = c.clearFilters;
    $scope.getTotalCount = c.getTotalCount;
    
    // Log initial stats
    c.logStats();
    
    // Watch for data changes
    $scope.$watch('data.myRetros', function(newVal) {
        if (newVal) {
            console.log('My Retros updated:', newVal.length);
        }
    }, true);
    
    $scope.$watch('data.teamRetros', function(newVal) {
        if (newVal) {
            console.log('Team Retros updated:', newVal.length);
        }
    }, true);
    
    $scope.$watch('data.myTasks', function(newVal) {
        if (newVal) {
            console.log('My Tasks updated:', newVal.length);
        }
    }, true);
    
    $scope.$watch('data.teamTasks', function(newVal) {
        if (newVal) {
            console.log('Team Tasks updated:', newVal.length);
        }
    }, true);
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.list-scroll {
  max-height: 500px;     /* adjust height as you like */
  overflow-y: auto;
}

.p-0 { padding: 0 !important; }
.p-md { padding: 15px; }
.m-b-none { margin-bottom: 0; }
.m-b-sm { margin-bottom: 10px; }
.m-t-none { margin-top: 0; }
.m-l-xs { margin-left: 4px; }
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>lists_container</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>LISTS CONTAINER</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  gs.info('=== List Container Server Script ===');
  
  data.myRetros = [];
  data.teamRetros = [];
  data.myTasks = [];
  data.teamTasks = [];
  data.currentUser = gs.getUserID();
  data.error = null;
  
  // Get current user info
  var userGR = new GlideRecord('sys_user');
  userGR.get(data.currentUser);
  var currentUserName = userGR.getDisplayName();
  gs.info('Current user: ' + currentUserName + ' (' + data.currentUser + ')');
  
  // Step 1: Find all teams the current user belongs to
  var myTeamIds = [];
  var teamMemberGR = new GlideRecord('x_1865669_retrospe_team_member');
  teamMemberGR.addQuery('user', data.currentUser);
  teamMemberGR.addQuery('active', true);
  teamMemberGR.query();
  
  while (teamMemberGR.next()) {
    var teamId = teamMemberGR.getValue('team');
    if (teamId) {
      myTeamIds.push(teamId);
    }
  }
  
  gs.info('User belongs to ' + myTeamIds.length + ' team(s): ' + myTeamIds.join(','));
  
  // Step 2: Build full team user set (including current user)
  var teamUserIds = [];
  
  // Always include current user as part of the team user set
  teamUserIds.push(data.currentUser);
  
  if (myTeamIds.length > 0) {
    var allMembersGR = new GlideRecord('x_1865669_retrospe_team_member');
    allMembersGR.addQuery('team', 'IN', myTeamIds.join(','));
    allMembersGR.addQuery('active', true);
    allMembersGR.query();
    
    while (allMembersGR.next()) {
      var memberId = allMembersGR.getValue('user');
      if (memberId && teamUserIds.indexOf(memberId) === -1) {
        teamUserIds.push(memberId);
      }
    }
  }
  
  gs.info('Team user set size: ' + teamUserIds.length + ' (' + teamUserIds.join(',') + ')');
  
  // Step 3: Load user's own retrospectives
  gs.info('Loading user retros...');
  var myRetroGR = new GlideRecord('x_1865669_retrospe_retrospective_submission');
  myRetroGR.addQuery('submitted_by', data.currentUser);
  myRetroGR.orderByDesc('submitted_date');
  myRetroGR.query();
  
  while (myRetroGR.next()) {
    var sprintGR = new GlideRecord('x_1865669_retrospe_sprint');
    sprintGR.get(myRetroGR.getValue('sprint'));
    
    data.myRetros.push({
      sys_id: myRetroGR.getUniqueValue(),
      number: myRetroGR.getDisplayValue('number'),
      sprint: sprintGR.getDisplayValue('sprint_name'),
      submitted_date: myRetroGR.getValue('submitted_date'),
      status: myRetroGR.getDisplayValue('status'),
      // adjust status value if your choice is 'submitted'
      isEditable: myRetroGR.getValue('status') === 'submitted',
      isOwner: true
    });
  }
  
  gs.info('Found ' + data.myRetros.length + ' user retros');
  
  // Step 4: Load team retrospectives (all users in same teams, including current user)
  gs.info('Loading team retros...');
  if (teamUserIds.length > 0) {
    var teamRetroGR = new GlideRecord('x_1865669_retrospe_retrospective_submission');
    teamRetroGR.addQuery('submitted_by', 'IN', teamUserIds.join(','));
    teamRetroGR.orderByDesc('submitted_date');
    teamRetroGR.query();
    
    while (teamRetroGR.next()) {
      var sprintGR2 = new GlideRecord('x_1865669_retrospe_sprint');
      sprintGR2.get(teamRetroGR.getValue('sprint'));
      
      var submittedById = teamRetroGR.getValue('submitted_by');
      
      data.teamRetros.push({
        sys_id: teamRetroGR.getUniqueValue(),
        number: teamRetroGR.getDisplayValue('number'),
        sprint: sprintGR2.getDisplayValue('sprint_name'),
        submitted_by: teamRetroGR.getDisplayValue('submitted_by'),
        submitted_date: teamRetroGR.getValue('submitted_date'),
        status: teamRetroGR.getDisplayValue('status'),
        isEditable: false,
        isOwner: submittedById === data.currentUser
      });
    }
  }
  
  gs.info('Found ' + data.teamRetros.length + ' team retros');
  
  // Step 5: Load user's assigned tasks
  gs.info('Loading user tasks...');
  var myTaskGR = new GlideRecord('x_1865669_retrospe_retrospective_task');
  myTaskGR.addQuery('assigned_to', data.currentUser);
  myTaskGR.orderByDesc('sys_created_on');
  myTaskGR.query();
  
  while (myTaskGR.next()) {
    data.myTasks.push({
      sys_id: myTaskGR.getUniqueValue(),
      number: myTaskGR.getDisplayValue('number'),
      short_description: myTaskGR.getValue('short_description'),
      state: myTaskGR.getDisplayValue('state'),
      isEditable: true,
      isOwner: true
    });
  }
  
  gs.info('Found ' + data.myTasks.length + ' user tasks');
  
  // Step 6: Load team tasks (all users in same teams, including current user)
  gs.info('Loading team tasks...');
  if (teamUserIds.length > 0) {
    var teamTaskGR = new GlideRecord('x_1865669_retrospe_retrospective_task');
    teamTaskGR.addQuery('assigned_to', 'IN', teamUserIds.join(','));
    teamTaskGR.orderByDesc('sys_created_on');
    teamTaskGR.query();
    
    while (teamTaskGR.next()) {
      var assignedToId = teamTaskGR.getValue('assigned_to');
      
      data.teamTasks.push({
        sys_id: teamTaskGR.getUniqueValue(),
        number: teamTaskGR.getDisplayValue('number'),
        short_description: teamTaskGR.getValue('short_description'),
        assigned_to: teamTaskGR.getDisplayValue('assigned_to'),
        state: teamTaskGR.getDisplayValue('state'),
        isEditable: false,
        isOwner: assignedToId === data.currentUser
      });
    }
  }
  
  gs.info('Found ' + data.teamTasks.length + ' team tasks');
  
  // Store team info for UI display
  data.hasTeam = myTeamIds.length > 0;
  data.teamMemberCount = teamUserIds.length;
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-08 12:48:03</sys_created_on>
        <sys_id>b068073383edb21089529370ceaad3c4</sys_id>
        <sys_mod_count>65</sys_mod_count>
        <sys_name>LISTS CONTAINER</sys_name>
        <sys_package display_value="Retrospective Management" source="x_1865669_retrospe">fe15f7248365fa5089529370ceaad3a1</sys_package>
        <sys_policy/>
        <sys_scope display_value="Retrospective Management">fe15f7248365fa5089529370ceaad3a1</sys_scope>
        <sys_update_name>sp_widget_b068073383edb21089529370ceaad3c4</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-12-15 09:43:20</sys_updated_on>
        <template><![CDATA[<div class="container">
  <!-- Header -->
  <div class="page-header">
    <h1 class="h3">
      <i class="fa fa-th-large"></i>
      Retrospective Dashboard
    </h1>
    <p class="text-muted">
      Manage your retrospectives and action items
    </p>
  </div>

  <div class="row">

    <!-- My Retrospectives -->
    <div class="col-sm-6 col-md-3">
      <div class="panel panel-default">
        <div class="panel-heading clearfix">
          <div class="pull-left">
            <i class="fa fa-pencil text-primary"></i>
            <span class="panel-title">My Retrospectives</span>
            <div class="text-muted small">Submissions I've created</div>
          </div>
          <span class="badge pull-right">{{data.myRetros.length}}</span>
        </div>
        <div class="panel-body p-0">
          <div ng-if="data.myRetros.length > 0"
               class="list-scroll list-group m-b-none">
            <a class="list-group-item"
               ng-repeat="retro in data.myRetros"
               ng-click="openRetro(retro.sys_id, $event)">
              <div>
                <!-- Retro number -->
                <div class="text-primary">
                  <i class="fa fa-file-text-o"></i>
                  <strong ng-bind="retro.number"></strong>
                </div>

                <!-- Sprint -->
                <div class="text-muted small">
                  <strong>Sprint:</strong>
                  <span ng-bind="retro.sprint"></span>
                </div>

                <!-- Submitted date -->
                <div class="text-muted small">
                  <strong>Submitted:</strong>
                  <i class="fa fa-calendar"></i>
                  <span ng-bind="retro.submitted_date | date:'MMM d, yyyy'"></span>
                </div>

                <!-- Status -->
                <div class="m-t-xs">
                  <strong>Status:</strong>
                  <span class="label label-default"
                        ng-class="'label-' + (retro.status || 'default')"
                        ng-bind="retro.status">
                  </span>
                </div>
              </div>
            </a>
          </div>

          <div ng-if="data.myRetros.length === 0"
               class="text-center text-muted p-md">
            <i class="fa fa-clipboard fa-2x m-b-sm"></i>
            <h4 class="h5 m-t-none">No retrospectives</h4>
            <p class="m-b-none">You haven't submitted any retrospectives yet.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Retrospectives -->
    <div class="col-sm-6 col-md-3">
      <div class="panel panel-default">
        <div class="panel-heading clearfix">
          <div class="pull-left">
            <i class="fa fa-users text-info"></i>
            <span class="panel-title">Team Retrospectives</span>
            <div class="text-muted small">From team members</div>
          </div>
          <span class="badge pull-right">{{data.teamRetros.length}}</span>
        </div>
        <div class="panel-body p-0">
          <div ng-if="data.teamRetros.length > 0"
               class="list-scroll list-group m-b-none">
            <a class="list-group-item"
               ng-repeat="retro in data.teamRetros"
               ng-click="openRetro(retro.sys_id, $event)">
              <div>
                <!-- Retro number -->
                <div class="text-info">
                  <i class="fa fa-file-text-o"></i>
                  <strong ng-bind="retro.number"></strong>
                </div>

                <!-- Sprint -->
                <div class="text-muted small">
                  <strong>Sprint:</strong>
                  <span ng-bind="retro.sprint"></span>
                </div>

                <!-- Assigned to (submitted_by) -->
                <div class="text-muted small">
                  <strong>Assigned to:</strong>
                  <i class="fa fa-user"></i>
                  <span ng-bind="retro.submitted_by"></span>
                </div>

                <!-- Submitted date -->
                <div class="text-muted small">
                  <strong>Submitted:</strong>
                  <i class="fa fa-calendar"></i>
                  <span ng-bind="retro.submitted_date | date:'MMM d, yyyy'"></span>
                </div>

                <!-- Status -->
                <div class="m-t-xs">
                  <strong>Status:</strong>
                  <span class="label label-default"
                        ng-class="'label-' + (retro.status || 'default')"
                        ng-bind="retro.status">
                  </span>
                </div>
              </div>
            </a>
          </div>

          <div ng-if="data.teamRetros.length === 0"
               class="text-center text-muted p-md">
            <i class="fa fa-users fa-2x m-b-sm"></i>
            <h4 class="h5 m-t-none">No team retrospectives</h4>
            <p class="m-b-none">No submissions yet.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- My Tasks -->
    <div class="col-sm-6 col-md-3">
      <div class="panel panel-default">
        <div class="panel-heading clearfix">
          <div class="pull-left">
            <i class="fa fa-check-circle text-success"></i>
            <span class="panel-title">My Tasks</span>
            <div class="text-muted small">Action items for me</div>
          </div>
          <span class="badge pull-right">{{data.myTasks.length}}</span>
        </div>
        <div class="panel-body p-0">
          <div ng-if="data.myTasks.length > 0"
               class="list-scroll list-group m-b-none">
            <a class="list-group-item"
               ng-repeat="task in data.myTasks"
               ng-click="openTask(task.sys_id, $event)">
              <div>
                <!-- Task number -->
                <div class="text-success">
                  <i class="fa fa-ticket"></i>
                  <strong ng-bind="task.number"></strong>
                </div>

                <!-- Short description -->
                <div class="text-muted small">
                  <strong>Short description:</strong>
                  <span ng-bind="task.short_description"></span>
                </div>

                <!-- Status -->
                <div class="m-t-xs">
                  <strong>Status:</strong>
                  <span class="label label-default"
                        ng-class="'label-' + (task.state || 'default')"
                        ng-bind="task.state">
                  </span>
                </div>
              </div>
            </a>
          </div>

          <div ng-if="data.myTasks.length === 0"
               class="text-center text-muted p-md">
            <i class="fa fa-check fa-2x m-b-sm"></i>
            <h4 class="h5 m-t-none">No tasks</h4>
            <p class="m-b-none">No action items assigned.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Tasks -->
    <div class="col-sm-6 col-md-3">
      <div class="panel panel-default">
        <div class="panel-heading clearfix">
          <div class="pull-left">
            <i class="fa fa-inbox text-warning"></i>
            <span class="panel-title">Team Tasks</span>
            <div class="text-muted small">For team members</div>
          </div>
          <span class="badge pull-right">{{data.teamTasks.length}}</span>
        </div>
        <div class="panel-body p-0">
          <div ng-if="data.teamTasks.length > 0"
               class="list-scroll list-group m-b-none">
            <a class="list-group-item"
               ng-repeat="task in data.teamTasks"
               ng-click="openTask(task.sys_id, $event)">
              <div>
                <!-- Task number -->
                <div class="text-warning">
                  <i class="fa fa-ticket"></i>
                  <strong ng-bind="task.number"></strong>
                </div>

                <!-- Short description -->
                <div class="text-muted small">
                  <strong>Short description:</strong>
                  <span ng-bind="task.short_description"></span>
                </div>

                <!-- Assigned to -->
                <div class="text-muted small">
                  <strong>Assigned to:</strong>
                  <i class="fa fa-user"></i>
                  <span ng-bind="task.assigned_to"></span>
                </div>

                <!-- Status -->
                <div class="m-t-xs">
                  <strong>Status:</strong>
                  <span class="label label-default"
                        ng-class="'label-' + (task.state || 'default')"
                        ng-bind="task.state">
                  </span>
                </div>
              </div>
            </a>
          </div>

          <div ng-if="data.teamTasks.length === 0"
               class="text-center text-muted p-md">
            <i class="fa fa-bullseye fa-2x m-b-sm"></i>
            <h4 class="h5 m-t-none">No team tasks</h4>
            <p class="m-b-none">No action items.</p>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>]]></template>
    </sp_widget>
</record_update>
